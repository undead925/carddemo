define(function(require){var e=require("jquery");require("regex");require("jquery.qrcode.min");var a=require("asPieProgress"),r=require("layer.m/1.6/layer.m"),t=require("../common"),o=e("#go_detail"),l=e("#borrow_submit"),n=e("#invest_percent"),i=e("#borrow_id"),s=e("#borrow_name"),c=e("#left_time"),f=e("#invest_submit"),v=e("#money"),d=e("#reward_id"),u=e("#reward_select"),p=e("#coupon_id"),h=e("#coupon_select"),w=e("#btnAuto"),b=e("#total_money"),m=e("#mini_num"),y=e("#user_balance"),_=e("#invest_balance"),g=e("#pay_password"),x=e("#type"),F="",q="",C=e("#borrow_type"),k=e("#reward_url");r.closeAll();r.open({type:2,shadeClose:false,content:"加载中..."});function P(){var a=0;if(d.val()!=""){u.find("option").each(function(){var r=e(this).attr("value");if(r==d.val()){a=parseFloat(e(this).attr("data"));return a}})}return a}function j(){var e=P();var a=0;if(v.val()!=""){a=parseFloat(v.val())}b.text((a+e).toFixed(2))}function I(){b.text("0.00")}e(function(){e("#header h1").text(s.val());if(x.val()=="index"||x.val()==""){e("#header a").eq(0).attr("href","/phone/borrow/borrow_list").html('<i class="qtydfont">&#xe623;</i>返回')}else{e("#header a").eq(0).attr("href","/phone/borrow/index/"+i.val()).html('<i class="qtydfont">&#xe623;</i>返回')}if(parseInt(c.val())>0){M(c.val(),l)}else{l.bind("click",function(){A(i.val())})}e(".project-progress").asPieProgress({namespace:"pieProgress"}).asPieProgress("go",n.val());v.blur(function(){I();F="";var a=e(this).val();if(e.trim(a)==""){F="请输入投资金额"}else if(!qtyd_regex.money(a)){F="金额必须为数字,且小数位数不能超过2位"}else if(parseFloat(a)<=0){F="请输入有效金额"}else{var r=parseFloat(a);var t=parseFloat(P());var o=parseFloat(y.val());var l=parseFloat(_.val());var n=parseInt(m.val());if(r>o){F="投资金额不能大于可用余额"}else if(r+t>l){F="投资总额不能大于标的可投金额"}else if(r+t<n){F="投资总额必须大于"+n}else if(l>n&&l<2*n&&r+t<l){F="尾单必须一次性投满"}else if(l-(r+t)>0&&l-(r+t)<n){F="请全部认购，或至少留下"+n}else{F=""}}if(F!=""){T(F,1);return false}j()}).keydown(function(e){var a=e.charCode?e.charCode:e.keyCode;return a>=48&&a<=57||a>=96&&a<=105||a==8||a==46||a==39||a==37||a==190||a==110});if(C.val()!=248){v.val("")}w.click(function(){var a=0;var r=parseFloat(y.val());var t=parseFloat(_.val());var o=0;u.find("option").each(function(){var r=e(this).attr("data");if(r!=""){var l=parseFloat(r);var n=e(this).val();if(l<t){if(l>o){o=l;d.val(n);u.val(n);a=l}}}});o=0;h.find("option").each(function(){var a=e(this).attr("data");if(a!=""){var r=parseFloat(a);var t=e(this).val();if(r>o){o=r;p.val(t);h.val(t)}}});var l=t-a;if(l>r){v.val(r.toFixed(2))}else{v.val(l.toFixed(2))}j()});u.change(function(){d.val(e(this).val());j()});h.change(function(){p.val(e(this).val())});g.blur(function(){var a=e(this).val();if(e.trim(a)==""){q="请输入支付密码"}else{q=""}if(q!=""){T(q,1);return false}});f.click(function(){v.trigger("blur");if(F!=""){return false}g.trigger("blur");if(q!=""){return false}var a=parseFloat(v.val());var t=P();var o=a+t;if(o>parseFloat(_.val())){T("投资总额不能大于标可投金额",1);return false}if(o<parseInt(m.val())){T("投资总额必须大于"+m.val(),1);return false}e(this).attr("disabled",true);var l=r.open({type:2,shadeClose:false,content:"系统处理中..."});e.ajax({url:"/phone/borrow/tender",type:"POST",dataType:"json",cache:false,data:{borrow_id:i.val(),invest_money:o,paypassword:g.val(),reward_id:d.val(),coupon_id:p.val()},success:function(a){f.attr("disabled",false);if(a.code==1e5){if(a.user_tendered==1&&a.have_reward==0){r.close(l);if(k.val()!=""){var t="";if("undefined"==typeof document.body.style.maxHeight){t="table"}else{t="canvas"}e("#reward_qrcode").qrcode({render:t,width:125,height:125,correctLevel:0,text:k.val(),src:"/assets/dist/images/moblie/reward.png"});e("#success_dialog").removeClass("hide")}}else{var o="恭喜，投资成功"+(a.reward>0?"，获得"+a.reward+"元红包":"");if(C.val()==248){o="恭喜您，11元现金稍后发放到您的账户，请注意查收。"}r.open({shadeClose:false,content:'<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">'+o+"</p></div>",btn:["继续投资","查看记录"],style:"min-width:300px;",yes:function(){window.location.href="/phone/borrow/borrow_list";return false},no:function(){window.location.href="/phone/account/invest_log/bidding";return false}})}}else if(a.code>=110023&&a.code<=110026){r.open({shadeClose:false,content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">登陆超时，请重新登录</p></div>',btn:["好"],style:"min-width:300px;",yes:function(){window.location.href="/phone/user/login.html";return false}})}else if(a.code==930019){window.location.href="/phone/error/sina_error";return false}else{T("投资失败，失败原因："+a.msg,3)}return false},error:function(){f.attr("disabled",false);T("投资失败",1);return false}})});r.closeAll()});function A(e){window.location.href="/phone/borrow/borrow_detail/"+e;return false}function M(e,a){var r=e;var t=setInterval(function(){if(r>0){r-=1;var e=Math.floor(r/3600%24);var o=Math.floor(r/60%60);var l=Math.floor(r%60);a.text((e<10?"0"+e:e)+":"+(o<10?"0"+o:o)+":"+(l<10?"0"+l:l))}else{clearInterval(t);a.text("立即投资").removeClass("countdown").unbind("click").bind("click",function(){A(i.val())})}},1e3)}function T(e,a){r.closeAll();r.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:a})}});