define(function(require){var e=require("jquery");require("../common");require("regex");var t=require("layer.m/1.6/layer.m"),a=e("#phone"),s=e("#password"),l=e("#reg_submit"),r=e("#valid_code"),i=e("#btnSendSms"),n=e("#invite_user"),o=e("#ff"),c=e("#track_id"),d=e("#from_url"),f=e("#ip"),u=e("#invite_code"),h=e("#btnSendVoiceSms"),p=e("#img_valid_code"),v=e("#div_voice_sms"),m,g,y="",b="",_="",x="",w=e("#div_voice_sms_tips");t.closeAll();t.open({type:2,shadeClose:false,content:"加载中..."});e(function(){e("#header h1").text("注册");a.blur(function(){var t=e(this).val();if(e.trim(t)==""){y=e(this).attr("nullmsg")}else if(!qtyd_regex.phone(t)){y=e(this).attr("errormsg")}else{y=""}if(y!=""){k(y,1);return false}e.ajax({url:"/utils/check_mobile",data:{type:"phone",param:t},type:"POST",dataType:"JSON",cache:false,success:function(e){if(e.code!=1e4){y="手机号码已经存在"}else{y="";if(e.show_img_code){if(g){window.clearInterval(g)}p.show();i.attr("disabled",false).text("短信验证码").removeClass("disabled");i.hide();r.val("");_="";v.hide()}}if(y!=""){k(y,1);return false}}})}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110});s.blur(function(){var t=e(this).val();if(e.trim(t)==""){b=e(this).attr("nullmsg")}else if(!(t.length>=6&&t.length<=24)){b=e(this).attr("errormsg")}else{b=""}if(b!=""){k(b,1);return false}});n.blur(function(){var t=e(this).val();if(e.trim(t)!=""){e.ajax({url:"/utils/check_mobile",data:{type:"phone",param:t},type:"POST",dataType:"json",cache:false,async:false,success:function(e){if(e.code==1e4){x="邀请人号码还未注册";k(x,1);return false}else{x=""}}})}});r.blur(function(){a.trigger("blur");if(y!=""){return false}var t=e(this).val();if(p.is(":visible")){if(e.trim(t)==""){_="请输入图形验证码"}else{_=""}if(_==""){e.ajax({url:"/utils/check_img_valid_code",data:{valid_code:t},type:"POST",dataType:"json",cache:false,success:function(e){if(e.code!=1e4){_="图形验证码错误";k(_,1);return false}else{_="";p.hide();i.show();r.val("");C(0);return false}},error:function(){k("图形验证码错误",1);return false}})}if(_!=""){k(_,1);return false}}else{if(e.trim(t)==""){_="请输入验证码"}else if(!qtyd_regex.number(t)){_="验证码格式错误"}else{_=""}if(_==""){e.ajax({url:"/async/check_valicode",data:{valicode:t,phone:a.val(),sms_type:"registered"},type:"POST",dataType:"json",cache:false,async:false,success:function(e){if(e.code!=1e4){_="验证码错误"}else{_=""}}})}if(_!=""){k(_,1);return false}}}).on("input",function(){var t=e(this).val();if(e.trim(t).length==4){if(p.is(":visible")){e.ajax({url:"/utils/check_img_valid_code",data:{valid_code:t},type:"POST",dataType:"json",cache:false,async:true,success:function(e){if(e.code!=1e4){_="验证码错误";k(_,1);return false}else{_="";p.hide();i.show();r.val("");C(0);return false}},error:function(){k("验证码错误",1);return false}})}}});p.click(function(){e(this).attr("src","/admin/verify?_r="+Math.random())});i.click(function(){a.trigger("blur");if(y!=""){return false}C(0)});h.on("click",function(){a.trigger("blur");if(y!=""){return false}C(1)});l.click(function(){if(_!=""){k(_,1);return false}a.trigger("blur");if(y!=""){return false}s.trigger("blur");if(b!=""){return false}r.trigger("blur");if(_!=""){return false}n.trigger("blur");if(x!=""){k(x,1);return false}t.open({type:2,shadeClose:false,content:"数据提交中..."});e.ajax({url:"/phone/user/reg",type:"POST",data:{phone:a.val(),password:s.val(),invite_user:n.val(),repassword:s.val(),valicode:r.val(),ff:o.val(),trackid:c.val(),fromurl:d.val(),invite_code:u.val()},cache:false,dataType:"json",success:function(e){if(e.code==1e5){t.closeAll();if(parseInt(e.register_info.tenthousand_reward)>0){t.open({content:'<div class="peculiar-user"><a href="/phone/account/sina_open"><img src="/assets/src/images/moblie/peculiar_user.png"><span>恭喜您获得万里挑一<br>第<em>'+parseInt(e.register_info.reg_rank)/1e4+"</em>万位注册用户红包</span></a></div>",type:1,style:"padding: 0; background-color:transparent; box-shadow: none; ",shadeClose:false})}else{t.open({content:'<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">恭喜，注册成功</p></div>',shadeClose:false,style:"min-width:300px;",btn:["好"],yes:function(){window.location.href="/phone/account/sina_open";return false}})}}else{k("抱歉，注册失败",1);if(g)clearInterval(g);i.attr("disabled",false).text("短信验证码").removeClass("disabled");return false}},error:function(){k("抱歉，注册异常",1);if(g)clearInterval(g);i.attr("disabled",false).text("短信验证码").removeClass("disabled");return false}})});t.closeAll()});function k(e,a){t.closeAll();t.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:a})}function C(s){t.closeAll();t.open({type:2,shadeClose:false,content:"系统处理中..."});if(g){window.clearInterval(g)}i.attr("disabled",true).text("短信验证码");e.ajax({type:"POST",cache:false,url:"/async/send_sms",dataType:"JSON",data:{phone:a.val(),sms_type:"registered",op_type:s,trackid:c.val(),ip:f.val()},success:function(e){t.closeAll();if(e.code==1e4){m=e.data.time;if(g)clearInterval(g);v.hide();w.hide().html("");if(s==1){w.show().html("请注意接听来电，验证码将在来电中播报......")}g=setInterval(function(){i.attr("disabled",true).text(m+"秒后重新发送").addClass("disabled");m-=1;if(m<0){clearInterval(g);w.hide().html("");v.show();i.attr("disabled",false).text("短信验证码").removeClass("disabled")}},1e3);_=""}else{_=e.msg;k(_,1);i.attr("disabled",false).text("短信验证码").removeClass("disabled")}return false},error:function(){_="网络异常，发送短信验证码失败，请重试";k(_,1);i.attr("disabled",false).text("短信验证码").removeClass("disabled")}})}e("#j-user-protocol").click(function(){var a=t.open({type:1,content:'<div class="protocol-head">祺天优贷注册协议</div><div class="protocol-cont" style="height:'+document.documentElement.clientHeight+'px; box-sizing: border-box;"><div id="user-protocol" style="overflow: auto; height:100%; "></div></div><div class="protocol-foot"><button class="btn-primary closediy">同意</button></div>',style:"width:100%; overflow:auto; height:"+document.documentElement.clientHeight+"px;",success:function(e){var s="getElementsByClassName";e[s]("closediy")[0].onclick=function(){t.close(a)}}});e("#user-protocol").load("/phone/user/reg_protocol.html")})});