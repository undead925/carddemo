define(function(require){var e=require("jquery");require("./common");require("regex");var t=require("layer.m/1.6/layer.m"),s=e("#phone"),a=e("#password"),l=e("#zc_submit"),r=e("#valid_code"),o=e("#btnSendSms"),n=e("#invite_user"),i=e("#ff"),c=e("#track_id"),d=e("#from_url"),f=e("#ip"),u=e("#div_voice_sms"),p=e("#btnSendVoiceSms"),h="",v="",m="",y="",g,b,_=e("#div_voice_sms_tips");t.closeAll();t.open({type:2,shadeClose:false,content:"加载中..."});e(function(){e("#header h1").text("注册");s.blur(function(){var t=e(this).val();if(e.trim(t)==""){h=e(this).attr("nullmsg")}else if(!qtyd_regex.phone(t)){h=e(this).attr("errormsg")}else{h=""}if(h==""){e.ajax({url:"/utils/check_mobile",data:{type:"phone",param:t},type:"POST",dataType:"json",cache:false,success:function(e){if(e.code!=1e4){h="手机号码已经存在"}else{h=""}if(h!=""){C(h,1);return false}}})}if(h!=""){C(h,1);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110});a.blur(function(){var t=e(this).val();if(e.trim(t)==""){v=e(this).attr("nullmsg")}else if(!(t.length>=6&&t.length<=24)){v=e(this).attr("errormsg")}else{v=""}if(v!=""){C(v,1);return false}});n.blur(function(){var t=e(this).val();if(e.trim(t)!=""){if(!qtyd_regex.phone(t)){y="邀请人号码格式不正确"}else{y=""}if(y==""){e.ajax({url:"/utils/check_mobile",data:{type:"phone",param:t},type:"POST",dataType:"json",cache:false,async:false,success:function(e){if(e.code==1e4){y="邀请人号码还未注册";C(y,1);return false}else{y=""}}})}if(y!=""){C(y,1);return false}}});r.blur(function(){var t=e(this).val();if(e.trim(t)==""){m="请输入短信验证码"}else if(!qtyd_regex.number(t)){m="短信验证码格式错误"}else{m=""}if(m==""){e.ajax({url:"/async/check_valicode",data:{valicode:t,phone:s.val(),sms_type:"registered"},type:"POST",dataType:"json",cache:false,async:false,success:function(e){if(e.code!=1e4){m="短信验证码错误"}else{m=""}}})}if(m!=""){C(m,1);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110});o.on("click",function(){return x(0)});p.on("click",function(){x(1)});l.click(function(){s.trigger("blur");if(h!=""){return false}a.trigger("blur");if(v!="")return false;r.trigger("blur");if(m!=""){return false}n.trigger("blur");if(y!=""){return false}t.closeAll();t.open({type:2,shadeClose:false,content:"数据提交中..."});e.ajax({url:"/phone/user/reg",type:"POST",data:{phone:s.val(),password:a.val(),invite_user:n.val(),repassword:a.val(),valicode:r.val(),ff:i.val(),trackid:c.val(),from_url:d.val()},cache:false,dataType:"json",success:function(e){if(e.code==1e5){t.closeAll();if(parseInt(e.register_info.tenthousand_reward)>0){t.open({content:'<div class="peculiar-user"><a href="/phone/account/sina_open"><img src="/assets/src/images/moblie/peculiar_user.png"><span>恭喜您获得万里挑一<br>第<em>'+parseInt(e.register_info.reg_rank)/1e4+"</em>万位注册用户红包</span></a></div>",type:1,style:"padding: 0; background-color:transparent; box-shadow: none; ",shadeClose:false})}else{t.open({content:'<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">恭喜，注册成功</p></div>',shadeClose:false,style:"min-width:300px;",btn:["好"],yes:function(){window.location.href="/phone/account/sina_open";return false}})}}else{C("抱歉，注册失败",1);if(b)clearInterval(b);o.attr("disabled",false).text("短信验证码").removeClass("disabled")}},error:function(){C("抱歉，注册异常",1);if(b)clearInterval(b);o.attr("disabled",false).text("短信验证码").removeClass("disabled")}})});t.closeAll()});function x(a){s.trigger("blur");if(h!="")return false;if(b){window.clearInterval(b)}o.attr("disabled",true).text("短信验证码");t.closeAll();t.open({type:2,shadeClose:false,content:"数据提交中..."});e.ajax({type:"POST",cache:false,url:"/async/send_sms",dataType:"JSON",data:{phone:s.val(),sms_type:"registered",op_type:a,trackid:c.val(),ip:f.val()},success:function(e){t.closeAll();if(e.code==1e4){g=e.data.time;if(b)clearInterval(b);u.hide();_.hide().html("");if(a==1){_.show().html("请注意接听来电，验证码将在来电中播报......")}b=setInterval(function(){o.text(g+"秒后重新发送").addClass("disabled");g-=1;if(g<0){clearInterval(b);_.hide().html("");u.show();o.attr("disabled",false).text("短信验证码").removeClass("disabled")}},1e3);return false}else{C(e.msg,3);o.attr("disabled",false).text("短信验证码").removeClass("disabled")}return false},error:function(){C("网络异常，发送短信验证码失败，请重试",1);o.attr("disabled",false).text("短信验证码").removeClass("disabled");return false}})}function C(e,s){t.closeAll();t.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:s})}e("#j-user-protocol").click(function(){var s=t.open({type:1,content:'<div class="protocol-head">祺天优贷注册协议</div><div class="protocol-cont" style="height:'+document.documentElement.clientHeight+'px; box-sizing: border-box;"><div id="user-protocol" style="overflow: auto; height:100%; "></div></div><div class="protocol-foot"><button class="btn-primary closediy">同意</button></div>',style:"width:100%; overflow:auto; height:"+document.documentElement.clientHeight+"px;",success:function(e){var a="getElementsByClassName";e[a]("closediy")[0].onclick=function(){t.close(s)}}});e("#user-protocol").load("/phone/user/reg_protocol.html")})});