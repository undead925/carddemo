define(function(require,exports,module){var e=require("jquery");var t=require("layer.m/1.6/layer.m");require("regex");require("area");require("../common");t.closeAll();t.open({type:2,shadeClose:false,content:"加载中..."});var n=e("#bank_add_submit"),a=e("#province_select"),o=e("#city_select"),l=e("#bank_code"),r=e("#bank_account"),s=e("#refer"),c="",i="",d="",f=e("#phone_no"),u=e("#valid_code"),h=e("#open_quick_submit"),v=e("#btnSendSms"),p=e("#record_no"),b=e("#add_type"),_=e("#bank_limit"),y="";e(function(){if(typeof _.val()!="undefined"&&_.val()!=""){y=e.parseJSON(_.val());l.change(function(){var n=e(this).val();if(n.length>0){for(var a=0;a<y.length;a++){var o=y[a].bank_info.update_start_time,r=y[a].bank_info.update_end_time,s=y[a].bank_info.bank_channel;if(y[a].bank_info.bank_code==n){if(o!=""&&r!=""&&(g(s,"|","quick_bind")||g(s,"|","bank_bind"))){var c=new Date(o).getTime(),i=new Date(r).getTime(),d=(new Date).getTime();if(c<=d&&i>=d){t.closeAll();t.open({content:"该行于"+o+"至"+r+"进行系统升级，请稍后再试！",btn:["知道了"],shadeClose:false});l.val("");return false}}}}}})}if(b.val()==1||b.val()==2){e("#header h1").text("开通快捷卡")}else{e("#header h1").text("添加银行卡")}e("#header a").eq(0).attr("href","/phone/account/bank_list").html('<i class="qtydfont">&#xe623;</i>返回');get_area(0);a.change(function(){var t=e(this).children("option:selected").val();var n="area_id="+t;e.ajax({url:"/async/area_non_tree",cache:false,dataType:"json",data:n,type:"POST",success:function(e){bind_area(e)}})});r.blur(function(){var t=e(this).val();if(!qtyd_regex.bank_account(t)){c="银行卡号格式错误"}else c="";if(c!=""){m(c,1);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110});n.click(function(){if(l.val()==""){m("请选择所属银行",1);return false}r.trigger("blur");if(c!=""){m(c,1);return false}t.closeAll();t.open({type:2,shadeClose:false,content:"数据处理中..."});e.ajax({url:"/phone/account/bank_add",type:"POST",cache:false,data:{bank_code:l.val(),bank_account:r.val(),province_id:a.val(),city_id:o.val(),refer:s.val()},dataType:"json",success:function(e){if(e.code==1e5){window.location.href=e.redirect_url;return false}else if(e.code>=110023&&e.code<=110026){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">登陆超时，请重新登录</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/user/login.html";return false}})}else if(e.code==930019){window.location.href="/phone/error/sina_error";return false}else{m("添加银行卡失败，失败原因："+e.msg,3);return false}},error:function(){m("添加失败",1);return false}})});f.blur(function(){var t=e(this).val();if(e.trim(t)==""){i=e(this).attr("nullmsg")}else if(!qtyd_regex.phone(t)){i=e(this).attr("errormsg")}else{i=""}if(i!=""){m(i,1);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110});u.blur(function(){var t=e(this).val();if(e.trim(t)==""){d=e(this).attr("nullmsg")}else{d=""}if(d!=""){m(d,1);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110});var w=120,k;v.click(function(){f.trigger("blur");if(i!=""){m(i,1);return false}t.closeAll();t.open({type:2,shadeClose:false,content:"短信发送中..."});e.ajax({url:"/phone/account/bank_add2_send_sms",type:"POST",data:{phone_no:f.val(),record_no:p.val()},dataType:"json",cache:false,success:function(e){if(e.code==1e5){p.val(e.record_no);t.closeAll();if(k)clearInterval(k);k=setInterval(function(){v.attr("disabled",true).text(w+"秒后重新发送").addClass("disabled");w-=1;if(w<0){v.attr("disabled",false).text("短信验证码").removeClass("disabled");clearInterval(k);w=120}},1e3)}else if(e.code>=110023&&e.code<=110026){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">登陆超时，请重新登录</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/user/login.html";return false}})}else if(e.code==930019){window.location.href="/phone/error/sina_error";return false}else{m("发送验证码失败，原因：<br>"+e.msg,3);return false}},error:function(){m("发送验证码失败",1);return false}})});e("#j-protocol").click(function(){var n=t.open({type:1,content:'<div class="protocol-head">新浪支付快捷支付使用协议</div><div class="protocol-cont" style="height:'+document.documentElement.clientHeight+'px; box-sizing: border-box;"><div id="user-protocol" style="overflow: auto; height:100%; "></div></div><div class="protocol-foot"><button class="btn-primary closediy">同意</button></div>',style:"width:100%; overflow:auto; height:"+document.documentElement.clientHeight+"px;",success:function(e){var a="getElementsByClassName";e[a]("closediy")[0].onclick=function(){t.close(n)}}});e("#user-protocol").load("/welcome/sina_pay_service_protocol_box")});h.click(function(){f.trigger("blur");if(i!=""){m(i,1);return false}u.trigger("blur");if(d!=""){m(d,1);return false}t.closeAll();t.open({type:2,shadeClose:false,content:"数据提交中..."});e.ajax({url:"/phone/account/bank_add2",type:"POST",data:{phone_no:f.val(),record_no:p.val(),valid_code:u.val(),refer:s.val()},cache:false,dataType:"json",success:function(e){if(e.code==1e5){t.closeAll();var n="";if(b.val()==1){n='<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">开通快捷卡成功</p></div>'}else{n='<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">添加快捷卡成功</p></div>'}t.open({content:n,shadeClose:false,style:"min-width:300px;",btn:["充值","查看"],yes:function(){window.location.href="/phone/account/recharge";return false},no:function(){window.location.href="/phone/account/bank_list";return false}})}else if(e.code==900004||e.code==930016){p.val(e.record_no);m(e.msg,3);if(k)clearInterval(k);w=120;k=setInterval(function(){v.attr("disabled",true).text(w+"秒后重新发送").addClass("disabled");w-=1;if(w<0){v.attr("disabled",false).text("短信验证码").removeClass("disabled");clearInterval(k);w=120}},1e3);return false}else if(e.code>=110023&&e.code<=110026){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">登陆超时，请重新登录</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/user/login.html";return false}})}else if(e.code==930019){window.location.href="/phone/error/sina_error";return false}else{m("开通快捷支付失败，原因："+e.msg,3);if(k)clearInterval(k);v.attr("disabled",false).text("短信验证码").removeClass("disabled");clearInterval(k);w=120;return false}},error:function(){m("开通快捷支付失败",1);return false}})});t.closeAll()});function m(e,n){t.closeAll();t.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:n})}function g(e,t,n){if(e==""||t==""||n=="")return false;e=e.toLocaleString();n=n.toLocaleString();var a=e.split(t);for(var o=0;o<a.length;o++){if(a[o]==n){return true}}return false}});