define(function(require,exports,module){var e=require("jquery");var s=require("layer.m/1.6/layer.m");require("regex");require("../common");s.closeAll();s.open({type:2,shadeClose:false,content:"加载中..."});var t=e("#valid_code"),a=e("#password"),l=e("#repassword"),n=e("#pay_pwd_submit"),r=e("#btnSendSms"),o=e("#phone"),i=e("#div_voice_sms"),c=e("#btnSendVoiceSms"),d="",f="",u="",p,h,v=e("#div_voice_sms_tips");e(function(){e("#header h1").text("支付密码");e("#header a").eq(0).attr("href","/phone/mine/safety").html('<i class="qtydfont">&#xe623;</i>返回');t.blur(function(){var s=e(this).val();if(e.trim(s)==""){d="必须输入手机验证码"}else{d=""}if(d!=""){m(d,1);return false}}).keydown(function(e){var s=e.charCode?e.charCode:e.keyCode;return s>=48&&s<=57||s>=96&&s<=105||s==8||s==46||s==39||s==37||s==110});a.blur(function(){var s=e(this).val();if(e.trim(s)==""){f="请输入新支付密码"}else if(!(s.length>=6&&s.length<=24)){f="6-24位字符，区分大小写"}else{f=""}if(f!=""){m(f,1);return false}});l.blur(function(){var s=e(this).val();if(s!=a.val()){u="两次密码输入不一致";m(u,1);return false}else{u=""}});r.click(function(){y(0)});c.click(function(){y(1)});n.click(function(){t.trigger("blur");if(d!="")return false;a.trigger("blur");if(f!="")return false;l.trigger("blur");if(u!=""){return false}s.closeAll();s.open({content:"更新中...",type:2,shadeClose:false});e.ajax({url:"",type:"POST",data:{valicode:t.val(),password:a.val(),repassword:l.val()},cache:false,dataType:"json",success:function(e){if(e.code==1e5){s.closeAll();s.open({content:'<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">支付密码修改成功</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/mine/safety";return false}})}else{m(e.msg,3);return false}},error:function(){m("支付密码修改失败",1);return false}})});s.closeAll()});function m(e,t){s.closeAll();s.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:t})}function y(t){s.closeAll();s.open({content:"验证码发送中...",type:2,shadeClose:false});r.attr("disabled",true).addClass("disabled");e.ajax({url:"/async/send_sms",type:"POST",data:{phone:o.val(),sms_type:"forget_paypassword",op_type:t},dataType:"JSON",cache:false,success:function(e){if(e.code==1e4){p=e.data.time;if(h)clearInterval(h);i.hide();v.hide().html("");if(t==1){v.show().html("请注意接听来电，验证码将在来电中播报......")}s.closeAll();h=setInterval(function(){r.text(p+"秒后重新发送");p=p-1;if(p<0){clearInterval(h);v.hide().html("");i.show();r.attr("disabled",false).text("短信验证码").removeClass("disabled")}},1e3)}else{m("验证码发送失败，失败原因："+e.msg,3);r.attr("disabled",false).text("短信验证码").removeClass("disabled");return false}},error:function(){m("网络异常，发送短信验证码失败，请重试",1);r.attr("disabled",false).text("短信验证码").removeClass("disabled");return false}})}});