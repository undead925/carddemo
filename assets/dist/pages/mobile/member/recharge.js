define(function(require,exports,module){var e=require("jquery"),t=require("layer.m/1.6/layer.m"),a=require("../common");require("regex");t.closeAll();t.open({type:2,shadeClose:false,content:"加载中..."});var l=e("#money"),s=e("#valid_code"),n=e("#bank_id"),o=e("#btnSendSms"),r=e("#record_no"),i=e("#recharge_submit"),c=e("#first_money"),d=e("#limit_day_money"),f=e("#limit_one_money"),u=e("#is_exists_bank"),v="",h="";e(function(){e("#header h1").text("充值");e("#header a").eq(0).attr("href","/phone/account/").html('<i class="qtydfont">&#xe623;</i>返回');e("#j-bank-list-more").click(function(){e(".bank-list-item").show()});if(parseInt(u.val())==0){t.open({content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">您还没有可用快捷卡，请您添加</p></div>',shadeClose:false,btn:["好"],style:"min-width:300px;",yes:function(){window.location.href="/phone/account/bank_add";return false}});return false}var a=e("section[name='safety_bank']");if(a.length>0){var m=a.eq(0);if(m.hasClass("selected")){m.addClass("selected");n.val(m.attr("id"))}}var y=e("section[name='quick_bank']");if(y.length>0){for(var _=0;_<y.length;_++){var g=y.eq(_).attr("id");var x=e("#bank_tips_"+g);if(x.val()==""){var C=y.eq(_).attr("data").split("_");c.text(C[0]);d.text(C[2]);f.text(C[1]);y.eq(_).addClass("selected");n.val(y.eq(_).attr("id"));break}}}l.blur(function(){var t=e(this).val();if(e.trim(t)==""){v="必须输入充值金额"}else if(!qtyd_regex.money(t)){v="金额必须为数字，小数点后不超过2位"}else if(parseFloat(t)<1.01){v="最小充值金额为1.01元"}else{v=""}if(v!=""){p(v,1);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110||t==190});s.blur(function(){var t=e(this).val();if(e.trim(t)==""){h="请输入短信验证码"}else if(!qtyd_regex.valid_code(t)){h="验证码格式错误，应为6位纯数字"}else{h=""}if(h!=""){p(h,1);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==110});var w=120,k;o.click(function(){if(n.val()==""){p("请选择充值银行卡",1);return false}l.trigger("blur");if(v!=""){return false}t.open({type:2,shadeClose:false,content:"短信发送中..."});e.ajax({url:"/phone/account/recharge",type:"POST",data:{money:l.val(),bank_id:n.val()},cache:false,dataType:"json",success:function(e){if(e.code==1e5){r.val(e.record_no);t.closeAll();if(k)clearInterval(k);k=setInterval(function(){o.attr("disabled",true).text(w+"秒后重新发送").addClass("disabled");w-=1;if(w<0){o.attr("disabled",false).text("短信验证码").removeClass("disabled");clearInterval(k);w=120}},1e3)}else if(e.code>=110023&&e.code<=110026){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">登陆超时，请重新登录</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/user/login.html";return false}})}else if(e.code==930019){window.location.href="/phone/error/sina_error";return false}else{p("发送验证码失败，原因："+e.msg,3);return false}},error:function(){p("发送验证码失败，请稍后再试",1);return false}})});i.click(function(){if(n.val()==""){p("请选择充值银行卡",1);return false}l.trigger("blur");if(v!="")return false;s.trigger("blur");if(h!="")return false;t.open({type:2,shadeClose:false,content:"充值中..."});e.ajax({url:"/phone/account/recharge2",type:"POST",data:{money:l.val(),bank_id:n.val(),valid_code:s.val(),record_no:r.val()},cache:false,dataType:"json",success:function(e){if(e.code==1e5){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">充值成功</p></div>',btn:["投资","查看"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/borrow/borrow_list";return false},no:function(){window.location.href="/phone/account/trade_log?account_type=recharge";return false}})}else if(e.code==930028||e.code==930020){r.val(e.record_no);w=120;p(e.msg,3);if(k)clearInterval(k);k=setInterval(function(){o.attr("disabled",true).text(w+"秒后重新发送").addClass("disabled");w-=1;if(w<0){o.attr("disabled",false).text("短信验证码").removeClass("disabled");clearInterval(k);w=120}},1e3)}else if(e.code>=110023&&e.code<=110026){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">登陆超时，请重新登录</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/user/login.html";return false}})}else if(e.code==930019){window.location.href="/phone/error/sina_error";return false}else{p("充值失败，原因："+e.msg,3);if(k)clearInterval(k);w=120;o.attr("disabled",false).text("短信验证码").removeClass("disabled");return false}},error:function(){p("充值失败，请稍后再试",1);return false}})});e("section[name='quick_bank']").each(function(){e(this).click(function(){b(e(this).attr("id"))})});e("#j-protocol").click(function(){var a=t.open({type:1,content:'<div class="protocol-head">新浪支付快捷支付使用协议</div><div class="protocol-cont" style="height:'+document.documentElement.clientHeight+'px; box-sizing: border-box;"><div id="user-protocol" style="overflow: auto; height:100%; "></div></div><div class="protocol-foot"><button class="btn-primary closediy">同意</button></div>',style:"width:100%; overflow:auto; height:"+document.documentElement.clientHeight+"px;",success:function(e){var l="getElementsByClassName";e[l]("closediy")[0].onclick=function(){t.close(a)}}});e("#user-protocol").load("/welcome/sina_pay_quick_service_protocol_box")});t.closeAll()});function b(t){var a=e("#"+t);var n=a.attr("data").split("_");a.addClass("selected");a.siblings().removeClass("selected");c.text(n[0]);d.text(n[2]);f.text(n[1]);var r=e("#tips");var u=e("#bank_tips_"+t);if(u.val()==""){e("#bank_id").val(t);r.addClass("hide").html("");l.attr("disabled",false);s.attr("disabled",false);o.attr("disabled",false).removeClass("disabled");i.attr("disabled",false).removeClass("disabled")}else{r.removeClass("hide").html(u.val());e("#bank_id").val("");l.attr("disabled",true);s.attr("disabled",true);o.attr("disabled",true).addClass("disabled");i.attr("disabled",true).addClass("disabled")}}function p(e,a){t.closeAll();t.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:a})}});