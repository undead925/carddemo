define(function(require){var e=require("jquery"),t=require("layer.m/1.6/layer.m");require("regex");require("../common");var o=e("#real_name"),n=e("#card_id"),s=e("#sina_open_submit"),l="",i="";e(function(){e("#header h1").text("开通新浪存钱罐");e("#header a").eq(0).attr("href","/phone/account/").html('<i class="qtydfont">&#xe623;</i>返回');o.blur(function(){var t=e(this).val();if(e.trim(t)==""){l=e(this).attr("nullmsg")}else{l=""}if(l!=""){c(l,1);return false}});n.blur(function(){var t=e(this).val();if(e.trim(t)==""){i=e(this).attr("nullmsg")}else if(!qtyd_regex.card_id_reg(t)){i=e(this).attr("errormsg")}else{i=""}if(i==""){e.ajax({type:"post",url:"/phone/mine/check_saving_pot_allow",cache:false,data:{card_id:t},dataType:"json",async:false,success:function(e){if(e.code==1){i=""}else{i="该身份证号不允许开通新浪支付存钱罐（可能已经开通）"}},error:function(){i="该身份证号不允许开通新浪支付存钱罐（可能已经开通）"}})}if(i!=""){c(i,3);return false}}).keydown(function(e){var t=e.charCode?e.charCode:e.keyCode;return t>=48&&t<=57||t>=96&&t<=105||t==8||t==46||t==39||t==37||t==88||t==120||t==110});s.click(function(){o.trigger("blur");if(l!="")return false;n.trigger("blur");if(i!="")return false;t.open({type:2,shadeClose:false,content:"开通中..."});e.ajax({url:"/phone/mine/sina_open",data:{real_name:o.val(),card_id:n.val()},type:"post",cache:false,dataType:"json",success:function(e){if(e.code==1e5){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-success ft25">&#xe61b;</i><p class="c-999 mt5">恭喜，开通成功</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){if(e.activity!=""){window.location.href=e.activity;return false}window.location.href="/phone/mine/novice_packs";return false}})}else if(e.code>=110023&&e.code<=110026){t.closeAll();t.open({content:'<div class="tac"><i class="qtydfont c-warning ft25">&#xe630;</i><p class="c-999 mt5">登陆超时，请重新登录</p></div>',btn:["好"],style:"min-width:300px;",shadeClose:false,yes:function(){window.location.href="/phone/user/login.html";return false}})}else if(e.code==930019){window.location.href="/phone/error/sina_error";return false}else{c("开通失败，失败原因："+e.msg,3);return false}},error:function(){c("开通失败",1);return false}})});t.closeAll()});e("#j-user-protocol").click(function(){var o=t.open({type:1,content:'<div class="protocol-head">存钱罐服务协议</div><div class="protocol-cont" style="height:'+document.documentElement.clientHeight+'px; box-sizing: border-box;"><div id="user-protocol" style="overflow: auto; height:100%; "></div></div><div class="protocol-foot"><button class="btn-primary closediy">同意</button></div>',style:"width:100%; overflow:auto; height:"+document.documentElement.clientHeight+"px;",success:function(e){var n="getElementsByClassName";e[n]("closediy")[0].onclick=function(){t.close(o)}}});e("#user-protocol").load("/welcome/saving_pot_service_protocol_box")});function c(e,o){t.closeAll();t.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:o})}});