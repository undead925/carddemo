define(function(require){function e(){return window.document.location.href}function o(){return window.document.location.pathname}function n(){return e().substring(0,e().indexOf(o()))}var i=require("jquery"),t=require("regex"),r=require("layer.m/1.6/layer.m"),a=require("../common");r.closeAll();r.open({type:2,shadeClose:false,content:"加载中..."});var s=require("https://res.wx.qq.com/open/js/jweixin-1.1.0.js");var c="",l="",d="",p="",u=encodeURIComponent(n()+"/topic/travel.html"),_="祺天优贷邀您免费旅行 报名火热进行中",f="您旅行我买单，五条旅游线路投票就送红包！跟着小祺免费去旅行吧！",h=n()+"/assets/dist/topic/return_banquet/images/return_banquet_2016.jpg";i.ajax({url:"/phone/weixin/getShareInfo?url="+encodeURIComponent(e()),async:false,dataType:"json",success:function(e,o){l=e.random;c=e.timestamp;d=e.signature;p=e.appid;w()},error:function(e,o,n){alert(n)}});function w(){s.config({debug:false,appId:p,timestamp:c,nonceStr:l,signature:d,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","translateVoice","startRecord","stopRecord","onRecordEnd","playVoice","pauseVoice","stopVoice","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard"]})}var g="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+p+"&redirect_uri="+u+"&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";s.ready(function(){s.hideAllNonBaseMenuItem();s.showMenuItems({menuList:["menuItem:share:appMessage","menuItem:share:timeline"]});s.onMenuShareAppMessage({title:_,desc:f,link:g,imgUrl:n()+"/assets/dist/topic/return_banquet/images/return_banquet_2016.jpg",trigger:function(e){},success:function(e){alert("分享成功")},cancel:function(e){alert("您取消了分享")},fail:function(e){}});s.onMenuShareTimeline({title:_,desc:f,link:g,imgUrl:n()+"/assets/dist/topic/return_banquet/images/return_banquet_2016.jpg",trigger:function(e){},success:function(e){alert("分享成功");window.location.href="/topic/travel.html?device_port="+m.device_port+"&redis_key="+m.redis_key;return false},cancel:function(e){alert("您取消了分享")},fail:function(e){}})});var m={user_id:parseInt(i("#user_id").val()),device_port:i("#device_port").val(),redis_key:i("#redis_key").val(),a_apply:i("#a_apply"),is_vote:parseInt(i("#is_vote").val()),is_sign_up:parseInt(i("#is_sign_up").val()),tour_items:i("li.tour-item"),route_id:parseInt(i("#route_id").val()),real_name:i("#realname"),start_origin:i("#start_origin"),contact_phone:i("#contact_phone"),sign_up_a:i("#sign_up_a"),user_tendered:parseInt(i("#user_tendered").val()),url:"/phone/user/login.html?&device_port="+i("#device_port").val()+"&redis_key="+i("#redis_key").val()+"&refer="+window.location.href,show_layer:function(e,o,n){var i=this,t="tips-info-line";if(n=="share"||n=="home"||n=="sign_up"){t="tips-info"}r.closeAll();var a=r.open({type:1,shadeClose:false,content:'<div class="tips-layer"><img src="/assets/dist/topic/return_banquet/images/layer_info_bg.png"><div class="'+t+'">'+e+'</div><a href="javascript:;" class="btn-layer">'+o+"</a><div></div></div>",style:" max-width: 560px; min-width:300px; background-color: transparent; box-shadow:none;",success:function(e){var o="getElementsByClassName";e[o]("btn-layer")[0].onclick=function(){if(n=="reload"){window.location.reload(true)}else if(n=="invest"){if(i.device_port.toString().toLowerCase()=="ios"||i.device_port.toString().toLowerCase()=="android"){window.location.href="app:borrow_list"}else{window.location.href="/phone/borrow/borrow_list"}}else if(n=="login"){if(i.device_port.toString().toLowerCase()=="ios"||i.device_port.toString().toLowerCase()=="android"){window.location.href="app:login"}else{window.location.href=i.url}}else if(n=="share"){if(i.device_port.toString().toLowerCase()=="ios"||i.device_port.toString().toLowerCase()=="android"){window.location.href='app:share:{"title":"'+_+'","content":"'+f+'","img":"'+h+'","url":"'+u+'","type":["wxtimeline"]}'}else{i.weixin_share()}}else if(n=="index"){window.location.href="/topic/travel.html?device_port="+i.device_port+"&redis_key="+i.redis_key}else if(n=="home"){window.location.href="app:home"}else if(n=="sign_up"){if(i.user_tendered>0){window.location.href="/phone/zt/return_banquet_2016_sign_up?device_port="+i.device_port+"&redis_key="+i.redis_key}else{i.show_layer("投资一次，即可报名！","去投资","invest")}}else{r.close(a)}return false}}})},show_error:function(e,o){r.closeAll();r.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:o})},close_layer:function(){r.closeAll()},login:function(){this.show_layer("投票赢红包！","登录","login")},vote:function(e,o){var n=this;m.close_layer();r.open({type:2,shadeClose:false,content:"数据处理中..."});i.ajax({url:"/phone/zt/travel_vote",data:{route_id:o},type:"POST",dataType:"JSON",cache:false,success:function(e){m.close_layer();if(e.code==1e4){var o="0";if(e.reward_info!=undefined){o=e.reward_info.reward_amount}n.show_layer("投票成功！<br/>您已赢得"+o+"元红包券！","去报名","sign_up")}else if(e.code==51004){n.show_layer("请您先登录！","登录","login")}else{n.show_error(e.msg,3)}}})},sign_up:function(){var e=this;if(i.trim(e.real_name.val())==""){e.show_error("请输入真实姓名",1);return false}if(i.trim(e.start_origin.val())==""){e.show_error("请输入始发地",1);return false}if(i.trim(e.contact_phone.val())==""){e.show_error("请输入真实手机号码",1);return false}else if(!qtyd_regex.phone(e.contact_phone.val())){e.show_error("手机号码格式错误",1);return false}m.close_layer();r.open({type:2,shadeClose:false,content:"提交处理中..."});i.ajax({url:"/phone/zt/travel_sign_up",data:{realname:e.real_name.val(),start_origin:e.start_origin.val(),contact_phone:e.contact_phone.val()},type:"POST",dataType:"JSON",cache:false,success:function(o){m.close_layer();if(o.code==1e4){if(window.location.href.indexOf("m.qtyd.com")>-1||window.location.href.indexOf("mm.qtyd.com")>-1||e.device_port.toString().toLowerCase()=="ios"||e.device_port.toString().toLowerCase()=="android"){e.show_layer("报名成功！<br/>期待4月18日旅行名单公布！","回到首页","home")}else{e.show_layer("报名成功！<br/>期待4月18日旅行名单公布！","分享到朋友圈","share")}}else if(o.code==51004){e.show_layer("请您先登录！","登录","login")}else{e.show_error("亲，请按规则填写报名哦！",2)}}})},init:function(){var e=this;if(e.user_id<=0){e.tour_items.find("a").each(function(){i(this).click(function(){e.login()})});e.a_apply.click(function(){e.login()})}else{if(e.is_vote>0){if(e.user_tendered<=0){e.a_apply.click(function(){e.show_layer("投资一次，即可报名！","去投资","invest")});e.tour_items.find("a").each(function(){i(this).click(function(){e.show_layer("投资一次，即可报名！","去投资","invest")})})}else{if(e.is_sign_up>0){e.a_apply.click(function(){e.show_layer("您已经报过名！","知道了","close")})}else{e.tour_items.find("a").each(function(){i(this).click(function(){if(i(this).hasClass("btn-apply")){window.location.href="/phone/zt/return_banquet_2016_sign_up/"+"?&device_port="+e.device_port+"&redis_key="+e.redis_key;return false}})});e.a_apply.click(function(){window.location.href="/phone/zt/return_banquet_2016_sign_up/?&device_port="+e.device_port+"&redis_key="+e.redis_key;return false})}}}else{e.tour_items.find("a").each(function(){i(this).click(function(){e.vote(i(this),i(this).attr("data"))})});e.a_apply.click(function(){e.show_layer("请先投票，再报名！","知道了","")})}}e.contact_phone.keydown(function(e){var o=e.charCode?e.charCode:e.keyCode;return o>=48&&o<=57||o>=96&&o<=105||o==8||o==46||o==39||o==37||o==110});e.sign_up_a.on("click",function(){e.sign_up()})},weixin_share:function(){this.show_layer("点击右上角，分享到朋友圈","知道了","index")}};i(function(){m.init();m.close_layer()})});