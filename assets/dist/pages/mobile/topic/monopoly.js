define(function(require){var e=require("jquery"),t=require("layer.m/1.6/layer.m"),o=require("../common"),i=require("asPieProgress");t.closeAll();t.open({type:2,shadeClose:false,content:"加载中..."});var n=1,s=false,r=false,l=20,f=0,a=50,c=1,g=0,d=0;var h=3,p=0,u=0,m=0,w=0,y=0;var _=0,v=0,T=0,b="";var q=0,x=0,A=0,C=0,I=0,j;e(function(){O();S();e("#car_run").click(function(){if(!s){var o=false;e("#count_down").find("img").css("width","0%").attr("src","/assets/dist/topic/monopoly/img/go3.png").find("img").show();t.open({type:2,shadeClose:false,content:"加载中..."});e.ajax({url:"/phone/zt/monopoly_lottery",type:"POST",data:{car_type:n},cache:false,async:false,dataType:"json",success:function(e){t.closeAll();console.log(e);if(e.code==1e4){u=e.position;b=e.pic;o=true}else{D(e.msg,5)}},error:function(e){D("抱歉，系统发生异常",5)}});if(o){clearInterval(r);r=false;h=parseInt(l/20)+2;I=(l/20-h+2)*120+30;m=Math.floor((228*(u-1)+684+I)*_/q);e(this).hide();e("#count_down").find("img").animate({height:"100%",width:"100%"},1e3);setTimeout(function(){e("#count_down").find("img").css("width","0%");e("#count_down").find("img").attr("src","/assets/dist/topic/monopoly/img/go2.png");e("#count_down").find("img").animate({height:"100%",width:"100%"},1e3)},1500);setTimeout(function(){e("#count_down").find("img").css("width","0%");e("#count_down").find("img").attr("src","/assets/dist/topic/monopoly/img/go1.png");e("#count_down").find("img").animate({height:"100%",width:"100%"},1e3)},3e3);setTimeout(function(){e("#count_down").find("img").css("width","0%");e("#count_down").find("img").attr("src","/assets/dist/topic/monopoly/img/go.png");e("#count_down").find("img").animate({height:"100%",width:"100%"})},4500);setTimeout(function(){e("#count_down").find("img").css("width","0%");e("#count_down").find("img").attr("src","/assets/dist/topic/monopoly/img/go.png");e("#count_down").find("img").animate({height:"100%",width:"100%"},{duration:1e3,queue:false,complete:k()})},6e3)}}});t.closeAll()});function k(){e("#count_down").find("img").hide();y=(h-2)*_+(_-T+e(".car").position().top)+m;s=setTimeout(M,a)}var P=false;function z(){e(".roller").each(function(){var t;var o=-(e(this).parent().offset().top-e(this).eq(0).offset().top)+10;if(o>=T){o=A;P=true}else{if(P){o=x;P=false}}e(this).css("top",o)});w+=10;d=(100-w/y*100)*(l/100).toFixed(2);e(".energy-bar").css("height",d+"%")}function M(){if(w+g>=y){F();return false}else{z();if(a!=c){if(a<25){j=10}else{j=f}if(p%j==0){a--}p++}s=setTimeout(M,a)}}function F(){z();if(a<=50){if(a<25){j=10}else{j=f}if(p%j==0){a++}p++;s=setTimeout(F,a)}else{s=true;p=0;e(".energy-bar").css("height","0%");B();e(".gift-box").find("img").attr("src","/assets/dist/topic/monopoly/img/gift/"+b);setTimeout(function(){e(".gift-layer").removeClass("hide")},2e3);return false}}function O(){n=e("#car_type").val();if(n==1){f=4;c=5;g=3030;q=3420}else if(n==2){f=2;c=1;g=2930;q=4104}}function S(){s=false;l=20;a=50;d=0;h=3;p=0;u=0;m=0;w=0;y=0;T=e(".roller").parent().height();_=e("#roller1").find("img").height();v=e(".car").find("img").height();e("#roller1").css("top",T-_);e("#roller2").css("top",T-_*2);x=-(e(".roller").parent().offset().top-e(".roller").eq(0).offset().top);A=-(e(".roller").parent().offset().top-e(".roller").eq(1).offset().top);clearInterval(r);r=false;e(".energy-bar").css("height","30%");var t=true;r=setInterval(function(){if(t){l+=1;if(l==100){t=false}}else{l-=1;if(l==30){t=true}}e(".energy-bar").css("height",l+"%")},15)}e("#init").click(function(){S();e("#car_run").show()});e(window).resize(function(){if(s==false&&p==0&&u==0){S()}else if(s!=false&&p!=0||u!=0&&s==false){clearTimeout(s);e("#count_down").find("img").hide();s=false;a=c;h=2;p=0;T=e(".roller").parent().height();_=e("#roller1").find("img").height();v=e(".car").find("img").height();e("#roller1").css("top",T-_);e("#roller2").css("top",T-_*2);x=-(e(".roller").parent().offset().top-e(".roller").eq(0).offset().top);A=-(e(".roller").parent().offset().top-e(".roller").eq(1).offset().top);m=Math.floor((228*(u-1)+684+100)*_/q);w=0;y=(h-1)*_-e(".car").position().top+m;d=50;e(".energy-bar").css("height","50%");M()}else if(s==true&&p==0){T=e(".roller").parent().height();_=e("#roller1").find("img").height();v=e(".car").find("img").height();var t=684*_/q+e(".car").position().top-T;e("#roller1").css("top",T-_+t+((u-1)*228+I)*_/q);e("#roller2").css("top",T-_*2+t+((u-1)*228+I)*_/q)}});function B(){T=e(".roller").parent().height();_=e("#roller1").find("img").height();v=e(".car").find("img").height();var t=684*_/q+e(".car").position().top-T;e("#roller1").css("top",T-_+t+((u-1)*228+I)*_/q);e("#roller2").css("top",T-_*2+t+((u-1)*228+I)*_/q)}function D(e,o){t.closeAll();t.open({content:e,type:1,style:"padding:10px 15px; background-color:rgba(0,0,0,0.5); color:#fff; border:none;",shadeClose:false,shade:false,time:o})}});